name: æ„å»º Windows EXE

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»º

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: false  # ç¦ç”¨submoduleï¼Œé¿å…submoduleé…ç½®é”™è¯¯
        fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼Œå‡å°‘submoduleå¤„ç†
    
    - name: ç¦ç”¨submoduleå¤„ç†
      run: |
        # å®Œå…¨ç¦ç”¨submoduleå¤„ç†
        git config --global submodule.recurse false
        git config --global --unset-all submodule.active 2>$null || echo "å·²æ¸…ç†"
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„.gitmoduleså¼•ç”¨
        if (Test-Path .gitmodules) {
          Remove-Item .gitmodules -Force -ErrorAction SilentlyContinue
        }
        # æ¸…ç†submoduleç¼“å­˜
        git rm --cached -r "1.åŸæ–‡ä»¶/LLM_resume_filter" 2>$null || echo "å·²æ¸…ç†"
        git rm --cached -r "7.LLM_resume_filter" 2>$null || echo "å·²æ¸…ç†"
      continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
      shell: pwsh
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        cd "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨"
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: æ„å»º EXEï¼ˆä½¿ç”¨collect-allç¡®ä¿åŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
      run: |
        cd "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨"
        pyinstaller --onefile `
          --name "AIç®€å†åˆç­›ç³»ç»Ÿ" `
          --add-data "data;data" `
          --add-data "index.html;." `
          --add-data "config.py;." `
          --hidden-import=fastapi `
          --hidden-import=uvicorn `
          --hidden-import=starlette `
          --hidden-import=pydantic `
          --hidden-import=websockets `
          --hidden-import=httptools `
          --hidden-import=anyio `
          --hidden-import=sniffio `
          --hidden-import=langchain_openai `
          --hidden-import=langchain_core `
          --hidden-import=openpyxl `
          --hidden-import=pandas `
          --hidden-import=numpy `
          --hidden-import=parsers.detect_merged_cells_with_accuracy `
          --hidden-import=parsers.detect_merged_cells_with_accuracy_position_adjust `
          --hidden-import=parsers.clean_external `
          --hidden-import=core.screener `
          --hidden-import=core.models `
          --hidden-import=core.toolkit `
          --hidden-import=managers.llm_manager `
          --hidden-import=utils.logger_config `
          --hidden-import=utils.data_loader `
          --hidden-import=utils.calculator `
          --hidden-import=utils.major_library `
          --collect-all fastapi `
          --collect-all uvicorn `
          --collect-all starlette `
          --collect-all pydantic `
          --collect-all websockets `
          --collect-all langchain_openai `
          --collect-all langchain_core `
          --collect-all openpyxl `
          --collect-all pandas `
          backend.py
      env:
        PYTHONIOENCODING: utf-8
      shell: pwsh
    
    - name: åˆ›å»ºéƒ¨ç½²åŒ…ç›®å½•ç»“æ„
      shell: cmd
      run: |
        cd "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨"
        if not exist "éƒ¨ç½²åŒ…" mkdir "éƒ¨ç½²åŒ…"
        copy dist\AIç®€å†åˆç­›ç³»ç»Ÿ.exe éƒ¨ç½²åŒ…\
        if not exist "éƒ¨ç½²åŒ…\data" mkdir "éƒ¨ç½²åŒ…\data"
        if not exist "éƒ¨ç½²åŒ…\output" mkdir "éƒ¨ç½²åŒ…\output"
        if not exist "éƒ¨ç½²åŒ…\logs" mkdir "éƒ¨ç½²åŒ…\logs"
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆEXEæ–‡ä»¶ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe-standalone
        path: "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨/dist/AIç®€å†åˆç­›ç³»ç»Ÿ.exe"
        retention-days: 30
    
    - name: ä¸Šä¼ å®Œæ•´éƒ¨ç½²åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: windows-deployment-package
        path: "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨/éƒ¨ç½²åŒ…/"
        retention-days: 30
    
    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      shell: cmd
      run: |
        cd "5.ç•Œé¢/æ¡ä»¶è¾ƒä¸ºç®€å•+å¤šè¡Œè¡¨"
        echo "âœ… æ„å»ºå®Œæˆï¼"
        echo "ğŸ“¦ EXEæ–‡ä»¶ä½ç½®: dist/AIç®€å†åˆç­›ç³»ç»Ÿ.exe"
        if exist "dist\AIç®€å†åˆç­›ç³»ç»Ÿ.exe" (
            dir dist\AIç®€å†åˆç­›ç³»ç»Ÿ.exe
            echo "æ–‡ä»¶å¤§å°:"
            for %%A in (dist\AIç®€å†åˆç­›ç³»ç»Ÿ.exe) do echo %%~zA å­—èŠ‚
        )
