# 重复序号问题说明

## 问题描述

在处理简历文件时，发现Excel文件中有7条记录，但筛选后只显示6条。

## 问题原因

通过分析发现，Excel文件中存在**重复的序号**：

```
序号列表: ['1', '2', '3', '4', '5', '2', '2']
姓名列表: ['王峰', '张明', '李炜役', '何名炀', '司徒图云', '张颖', '张湖']
```

可以看到，序号"2"出现了3次（对应张明、张颖、张湖三个人）。

### 技术原因

1. **筛选器使用序号作为简历标识**：
   - `result.resume_id` 存储的是简历的序号字段
   - 当有重复序号时，多份简历会有相同的 `resume_id`

2. **原始查找逻辑的问题**：
   ```python
   for resume in resumes_data:
       if str(resume.get('序号', '')) == resume_id:
           resume_data = resume
           break  # ❌ 这里会导致只找到第一个匹配的简历
   ```

3. **结果**：
   - 序号"2"的三份简历（张明、张颖、张湖）
   - 筛选器会为每份简历生成一个结果
   - 但在构建输出时，由于使用 `break`，只会找到第一个序号为"2"的简历（张明）
   - 张颖和张湖的筛选结果会被忽略

## 解决方案

修改了 `backend.py` 中的简历查找逻辑：

### 修改前
```python
for resume in resumes_data:
    if str(resume.get('序号', '')) == resume_id:
        resume_data = resume
        break  # 只找第一个
```

### 修改后
```python
# 1. 找到所有匹配的简历
matching_resumes = [resume for resume in resumes_data 
                   if str(resume.get('序号', '')) == resume_id]

# 2. 使用序号+姓名作为唯一标识，避免重复处理
processed_resumes = set()

# 3. 对于重复序号，依次处理每一份
for resume in matching_resumes:
    name = resume.get('基本信息', {}).get('姓名', '')
    unique_key = f"{resume_id}_{name}"
    if unique_key not in processed_resumes:
        resume_data = resume
        processed_resumes.add(unique_key)
        break
```

## 建议

### 短期建议
系统已经修复了重复序号的处理逻辑，可以正确处理重复序号的情况。

### 长期建议
1. **Excel文件规范**：
   - 确保简历的序号字段是唯一的
   - 建议使用自增序号或UUID

2. **数据验证**：
   - 在解析Excel时，检测并警告重复序号
   - 可以在 `detect_merged_cells_with_accuracy.py` 中添加验证逻辑

3. **使用更好的唯一标识**：
   - 考虑使用身份证号作为唯一标识（更可靠）
   - 或者使用序号+姓名的组合

## 验证方法

### 1. 检查JSON文件中的序号
```bash
python3 -c "import json; data = json.load(open('文件名.json', 'r', encoding='utf-8')); print('总记录数:', len(data)); print('序号列表:', [d.get('序号') for d in data])"
```

### 2. 检查是否有重复序号
```bash
python3 -c "import json; from collections import Counter; data = json.load(open('文件名.json', 'r', encoding='utf-8')); ids = [d.get('序号') for d in data]; duplicates = {k: v for k, v in Counter(ids).items() if v > 1}; print('重复的序号:', duplicates if duplicates else '无')"
```

### 3. 测试筛选功能
上传包含重复序号的Excel文件，验证所有简历都被正确处理。

## 修复后的效果

- ✅ 可以正确处理重复序号的简历
- ✅ 每份简历都会被独立筛选
- ✅ 所有筛选结果都会正确显示
- ✅ 不会丢失任何简历数据
